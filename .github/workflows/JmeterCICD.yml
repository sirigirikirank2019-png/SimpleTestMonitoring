name: JMeter CI/CD

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  jmeter-test:
    runs-on: ubuntu-22.04

    services:
      httpbin:
        image: kennethreitz/httpbin
        ports:
          - 91:80

      cadvisor:
        image: gcr.io/cadvisor/cadvisor:latest
        ports:
          - 8081:8080
        options: >-
          --volume=/:/rootfs:ro
          --volume=/var/run:/var/run:rw
          --volume=/sys:/sys:ro
          --volume=/var/lib/docker/:/var/lib/docker:ro

      prometheus:
        image: prom/prometheus:latest
        ports:
          - 9091:9090
        options: >-
          --volume=/tmp/prometheus:/etc/prometheus:ro

      grafana:
        image: grafana/grafana:latest
        ports:
          - 3001:3000
        env:
          GF_SECURITY_ADMIN_USER: admin
          GF_SECURITY_ADMIN_PASSWORD: admin
          GF_USERS_ALLOW_SIGN_UP: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget unzip openjdk-17-jre-headless
          echo "âœ… Prerequisites installed"

      - name: Prepare Prometheus config
        run: |
          mkdir -p /tmp/prometheus
          cat <<'EOF' > /tmp/prometheus/prometheus.yml
          global:
            scrape_interval: 5s
      
          scrape_configs:
            - job_name: 'cadvisor'
              static_configs:
                - targets: ['cadvisor:8080']
          EOF
      
          echo "ðŸš€ Starting Prometheus container..."
          docker run -d \
            -p 9090:9090 \
            -v $PWD/prometheus.yml:/etc/prometheus/prometheus.yml \
            --name prometheus prom/prometheus:latest
      
          echo "âœ… Prometheus started successfully"
          sleep 5
          curl -s http://localhost:9091/-/ready || echo "Prometheus not yet ready"

      - name: Wait for Monitoring Stack
        run: |
          echo "â³ Waiting for Prometheus (9091) and Grafana (3001)..."
          for i in {1..20}; do
            if curl -s -f http://localhost:9091/-/ready > /dev/null; then
              echo "âœ… Prometheus is ready!"
              break
            fi
            sleep 5
          done
          
          for i in {1..20}; do
            if curl -s -f http://localhost:3001/api/health > /dev/null; then
              echo "âœ… Grafana is ready!"
              break
            fi
            sleep 5
          done

      - name: Wait for HTTPBin and cAdvisor
        run: |
          for i in {1..10}; do
            if curl -s -f http://localhost:91/get > /dev/null; then
              echo "âœ… HTTPBin up!"
              break
            fi
            sleep 3
          done

          for i in {1..10}; do
            if curl -s -f http://localhost:8081/metrics > /dev/null; then
              echo "âœ… cAdvisor up!"
              break
            fi
            sleep 3
          done

      - name: Install JMeter
        run: |
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.zip
          unzip -q apache-jmeter-5.6.3.zip -d /opt/
          sudo ln -sf /opt/apache-jmeter-5.6.3/bin/jmeter /usr/local/bin/jmeter
          jmeter -v

      - name: Install JMeter Plugins
        run: |
          JMETER_HOME=/opt/apache-jmeter-5.6.3
          wget -q https://jmeter-plugins.org/get/ -O /tmp/JMeterPluginsManager.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar -O /tmp/cmdrunner-2.3.jar
          mkdir -p $JMETER_HOME/lib/ext
          cp /tmp/JMeterPluginsManager.jar $JMETER_HOME/lib/ext/
          cp /tmp/cmdrunner-2.3.jar $JMETER_HOME/lib/
          java -cp $JMETER_HOME/lib/ext/JMeterPluginsManager.jar org.jmeterplugins.repository.PluginManagerCMDInstaller
          $JMETER_HOME/bin/PluginsManagerCMD.sh install jpgc-casutg

      - name: Run JMeter Test
        run: |
          mkdir -p /tmp/results
          jmeter -n -t ./P01_HTTPBinAPI_StreeTest.jmx \
                 -l /tmp/results/results.jtl \
                 -e -o /tmp/results/report
          echo "âœ… JMeter test completed"

      - name: Collect Reports
        run: |
          mkdir -p /tmp/final_reports
          cp -r /tmp/results/report /tmp/final_reports/JMeter-Report || true
          
          curl -s http://localhost:8081/metrics > /tmp/final_reports/cadvisor_metrics.txt || true
          curl -s http://localhost:9091/api/v1/targets > /tmp/final_reports/prometheus_targets.json || true
          curl -s http://localhost:3001/api/health > /tmp/final_reports/grafana_health.json || true

          echo "âœ… Monitoring data collected"

      - name: Upload All Reports
        uses: actions/upload-artifact@v4
        with:
          name: Performance-Reports
          path: /tmp/final_reports
