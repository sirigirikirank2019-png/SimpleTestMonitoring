name: JMeter CI/CD

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  jmeter-test:
    runs-on: ubuntu-22.04

    services:
      httpbin:
        image: kennethreitz/httpbin
        ports:
          - 91:80

      cadvisor:
        image: gcr.io/cadvisor/cadvisor:latest
        ports:
          - 8081:8080
        options: >-
          --volume=/:/rootfs:ro
          --volume=/var/run:/var/run:rw
          --volume=/sys:/sys:ro
          --volume=/var/lib/docker/:/var/lib/docker:ro

      prometheus:
        image: prom/prometheus:latest
        ports:
          - 9091:9090
        options: >-
          --volume=${{ github.workspace }}/tmp/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro

      grafana:
        image: grafana/grafana:latest
        ports:
          - 3001:3000
        env:
          GF_SECURITY_ADMIN_USER: admin
          GF_SECURITY_ADMIN_PASSWORD: admin
          GF_USERS_ALLOW_SIGN_UP: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget unzip openjdk-17-jre-headless
          echo "✅ Prerequisites installed"

      - name: Wait for Services
        run: |
          echo "⏳ Waiting for services to start..."

          for i in {1..20}; do
            if curl -s -f http://localhost:91/get > /dev/null; then
              echo "✅ HTTPBin is ready!"
              break
            fi
            sleep 3
          done

          for i in {1..20}; do
            if curl -s -f http://localhost:8081/metrics > /dev/null; then
              echo "✅ cAdvisor is ready!"
              break
            fi
            sleep 3
          done

          for i in {1..20}; do
            if curl -s -f http://localhost:9091/-/ready > /dev/null; then
              echo "✅ Prometheus is ready!"
              break
            fi
            sleep 3
          done

          for i in {1..20}; do
            if curl -s -f http://localhost:3001/api/health > /dev/null; then
              echo "✅ Grafana is ready!"
              break
            fi
            sleep 3
          done

      - name: Install JMeter
        run: |
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.zip
          unzip -q apache-jmeter-5.6.3.zip -d /opt/
          sudo ln -sf /opt/apache-jmeter-5.6.3/bin/jmeter /usr/local/bin/jmeter
          jmeter -v

      - name: Run JMeter Test
        run: |
          mkdir -p /tmp/results
          jmeter -n -t ./P01_HTTPBinAPI_StreeTest.jmx \
                 -l /tmp/results/results.jtl \
                 -e -o /tmp/results/report
          echo "✅ JMeter test completed"

      - name: Collect Reports
        run: |
          mkdir -p /tmp/final_reports
          cp -r /tmp/results/report /tmp/final_reports/JMeter-Report || true

          curl -s http://localhost:8081/metrics > /tmp/final_reports/cadvisor_metrics.txt || true
          curl -s http://localhost:9091/api/v1/targets > /tmp/final_reports/prometheus_targets.json || true
          curl -s http://localhost:3001/api/health > /tmp/final_reports/grafana_health.json || true

          echo "✅ Monitoring data collected"

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: Performance-Reports
          path: /tmp/final_reports
